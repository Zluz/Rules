{
	"debug": false,
    "vars": {
        "PW1_percent": " 100.0 * ${body.fields.PW1_POD_nom_energy_remaining} / ${body.fields.PW1_POD_nom_full_pack_energy} ",
        "PW2_percent": " 100.0 * ${body.fields.PW2_POD_nom_energy_remaining} / ${body.fields.PW2_POD_nom_full_pack_energy} ",
        "nominal_percent": " 100.0 * ${body.fields.nominal_energy_remaining} / ${body.fields.nominal_full_pack_energy} "
    },
	"conditions": {
		"check-event-type": "'${headers.event-type}'.includes('Powerwall measurement')",
		"check-event-source": "'${headers.user-agent}'.includes('Telegraf')",
		"check-array-item": "'${headers.reprocess_key}'.includes('split-bulk-array')",
		"check-measurement-type": "'${body.name}' === 'http'",
		"check-measurement-detail": "${body.fields.nominal_full_pack_energy} > -1 ",
		"enabled": "true"
	},
	"actions": {
		"01 - action-tag": { 
			"type": "tag", 
			"value": "set - PW (batt pct)",
			"expire": 0
		},
		"02 - action-set-var home.upstairs": { 
			"type": "set", 
			"name": "Home",
			"path": "$.batteries.${headers.powerwall}.capacity",
			"value": "${headers.powerwall}",
			"add": {
			    "PW1_percent": "${PW1_percent}",
			    "PW2_percent": "${PW2_percent}",
			    "nominal_percent": "${nominal_percent}"
			}
		}
	}
}

